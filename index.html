<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±å–®ç·´ç¿’ï½œé¸æ“‡é¡Œï¼å¡«ç©ºé¡Œï¼ˆCSV å››æ¬„ï¼‰</title>
  <style>
    :root{ --bg:#0b1020; --card:#12182b; --muted:#9aa4bf; --text:#e6ecff; --accent:#5dd6ff; --ok:#3ddc97; --warn:#ffd166; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1f 0%,#0c1328 100%);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, PingFang TC, Helvetica, Arial}
    header{padding:18px 16px;border-bottom:1px solid #1b2440;position:sticky;top:0;background:rgba(9,14,28,.85);backdrop-filter: blur(10px);z-index:10}
    main{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    .grid{display:grid;gap:12px}
    .controls{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid #1b2440;border-radius:14px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243154;background:#0b1224;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(93,214,255,.15)}
    button{cursor:pointer;background:#1a2446;border-color:#223063}
    button.primary{background:linear-gradient(180deg,#2a76ff,#1d5aff);border:none}
    button.ghost{background:transparent;border:1px dashed #314070}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0d1630;border:1px solid #223063;color:#c7d3ff;font-size:12px}
    .question{font-size:22px;margin:12px 0 8px}
    .pos{font-size:13px;color:var(--muted)}
    .choices{display:grid;gap:10px}
    .choices button{justify-content:flex-start}
    .choice{padding:12px;border-radius:12px;background:#0b1224;border:1px solid #223063;text-align:left}
    .choice.correct{border-color:var(--ok)}
    .choice.wrong{border-color:var(--bad)}
    .progress{height:8px;background:#11193a;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:linear-gradient(90deg,#2a76ff,#5dd6ff)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;padding:2px 6px;border:1px solid #2b3b6d;border-radius:6px;background:#0d1430}
    .list{display:grid;gap:8px}
    .wrong-item{padding:10px;border-radius:10px;border:1px solid #2a375f;background:#0d1430}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .small{font-size:12px}
    .center{text-align:center}
    .hide{display:none}
    .hint{font-size:12px;color:#a9b6e6;margin-top:6px}
    .footer{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
    .link{color:#7ec8ff}
    .diag{font-size:12px;color:#c7d3ff;background:#0d1630;border:1px solid #223063;border-radius:10px;padding:8px;margin-top:8px}
    .chip{display:inline-block;background:#0d1630;border:1px solid #223063;border-radius:999px;padding:2px 8px;margin-right:6px}
  </style>
</head>
<body>
<header class="row">
  <h1>è‹±å–®ç·´ç¿’ï¼ˆé¸æ“‡ï¼å¡«ç©ºï¼‰</h1>
  <div class="right pill" id="datasetStatus">é¡Œåº«ï¼š<span class="muted">å°šæœªè¼‰å…¥</span></div>
</header>
<main class="grid">
  <section class="card">
    <div class="grid controls">
      <div>
        <label>é¡Œåº«ä¾†æºï¼ˆCSVï¼Œå››æ¬„ï¼šåºè™Ÿï¼è‹±æ–‡ï¼è©æ€§ï¼ä¸­æ–‡ï¼‰</label>
        <input id="sheetUrl" placeholder="è²¼ä¸Š Google è©¦ç®—è¡¨ã€ç™¼å¸ƒåˆ°ç¶²è·¯â†’CSVã€é€£çµï¼Œæˆ–ä½¿ç”¨é è¨­é¡Œåº«" />
        <div class="row" style="margin-top:8px">
          <button id="btnLoad" class="primary">è¼‰å…¥é¡Œåº«</button>
          <button id="btnLoadDefault" class="ghost">ç”¨é è¨­é¡Œåº«</button>
          <button id="btnUseSample" class="ghost">ä½¿ç”¨ç¯„ä¾‹é¡Œåº«</button>
        </div>
        <div class="hint">æœ¬é <strong>å›ºå®šæ”¯æ´ CSV å››æ¬„</strong>ï¼šåºè™Ÿã€è‹±æ–‡ã€è©æ€§ã€ä¸­æ–‡ã€‚<br>è‹¥æ¢ç›®ç„¡ä¸­æ–‡ï¼ˆä¾‹å¦‚äººåï¼‰ï¼Œæœƒè‡ªå‹•é¿é–‹å¡«ç©ºé¡Œï¼Œä½†ä»å¯ç”¨æ–¼é¸æ“‡é¡Œã€‚</div>
        <div id="diagBox" class="diag hide"></div>
      </div>
      <div>
        <label>å‡ºé¡Œç¯„åœï¼ˆç´¢å¼•ï¼›ä»¥é¡Œåº«åˆ—è™Ÿç‚ºæº–ï¼‰</label>
        <input id="range" placeholder="ä¾‹å¦‚ï¼š1-100 æˆ– 1-50, 120, 150-180"/>
        <div class="hint">æœƒè‡ªå‹•å¿½ç•¥è¶…å‡ºç¯„åœçš„ç´¢å¼•ã€‚</div>
      </div>
      <div>
        <label>é¡Œç›®æ•¸é‡</label>
        <input id="count" type="number" min="1" value="10" />
      </div>
      <div>
        <label>æ¸¬é©—æ¨¡å¼</label>
        <select id="mode">
          <option value="choice">é¸æ“‡é¡Œï¼ˆå››é¸ä¸€ï¼‰</option>
          <option value="fill">å¡«ç©ºé¡Œï¼ˆä¸­æ–‡ï¼‹è©æ€§ â†’ è‹±æ–‡ï¼‰</option>
          <option value="mixed">æ··åˆï¼ˆéš¨æ©ŸæŠ½é¸æ“‡æˆ–å¡«ç©ºï¼‰</option>
        </select>
      </div>
      <div>
        <label>é¡Œç›®é¡¯ç¤º</label>
        <select id="display">
          <option value="zh-pos">é¡¯ç¤ºï¼šä¸­æ–‡ï¼‹è©æ€§</option>
          <option value="en-pos">é¡¯ç¤ºï¼šè‹±æ–‡ï¼‹è©æ€§</option>
          <option value="auto">è‡ªå‹•ï¼ˆä¾æ¨¡å¼èª¿æ•´ï¼‰</option>
        </select>
        <div class="hint">é¸æ“‡é¡Œå»ºè­°é¡¯ç¤ºä¸­æ–‡ï¼‹è©æ€§ï¼›å¡«ç©ºé¡Œä¸€å¾‹ä¸­æ–‡ï¼‹è©æ€§ã€‚</div>
      </div>
      <div>
        <label>å…¶ä»–</label>
        <div class="row">
          <label class="pill" style="gap:8px"><input type="checkbox" id="allowTTS"> å•Ÿç”¨è‹±èªç™¼éŸ³ï¼ˆTTSï¼‰</label>
          <label class="pill" style="gap:8px"><input type="checkbox" id="caseIns" checked> è‹±æ–‡ä¸åˆ†å¤§å°å¯«</label>
        </div>
      </div>
    </div>
    <div class="footer">
      <button id="btnStart" class="primary">é–‹å§‹æ¸¬é©—</button>
      <button id="btnWrongPractice" class="ghost" title="ä½¿ç”¨æœ€è¿‘ä¸€æ¬¡éŒ¯é¡Œå†ç·´ç¿’" disabled>åªç·´éŒ¯é¡Œ</button>
      <button id="btnClearHistory" class="ghost">æ¸…é™¤æˆç¸¾ç´€éŒ„</button>
    </div>
  </section>

  <section id="quizCard" class="card hide">
    <div class="row">
      <div class="pill" id="quizMeta">ç¬¬ <span id="qIndex">1</span> / <span id="qTotal">10</span> é¡Œ</div>
      <div class="right" style="min-width:200px">
        <div class="progress"><div id="progBar" style="width:0%"></div></div>
      </div>
    </div>
    <div id="qStem" class="question">é¡Œç›®è¼‰å…¥ä¸­â€¦</div>
    <div id="qPos" class="pos"></div>

    <div id="choiceBox" class="choices"></div>

    <div id="fillBox" class="grid" style="gap:8px">
      <input id="fillInput" placeholder="è¼¸å…¥è‹±æ–‡ç­”æ¡ˆï¼ˆæŒ‰ Enter é€å‡ºï¼‰" autocomplete="off"/>
      <div class="row">
        <button id="btnSubmitFill" class="primary">é€å‡ºç­”æ¡ˆ</button>
        <button id="btnHint" class="ghost">æç¤ºï¼ˆé¦–å­—æ¯ï¼‰</button>
        <span id="hintText" class="hint"></span>
      </div>
    </div>

    <div class="footer">
      <button id="btnNext" class="ghost">ä¸‹ä¸€é¡Œ <span class="kbd">Enter</span></button>
      <button id="btnSpeak" class="ghost" title="ç™¼éŸ³" disabled>ğŸ”ˆ ç™¼éŸ³</button>
    </div>
  </section>

  <section id="resultCard" class="card hide">
    <h2>æˆç¸¾</h2>
    <p class="muted">æœ¬æ¬¡åˆ†æ•¸ï¼š<b id="scorePct">0%</b>ï¼ˆç­”å° <span id="scoreRight">0</span> / <span id="scoreTotal">0</span>ï¼‰</p>
    <div class="footer">
      <button id="btnRetry" class="primary">å†æ¸¬ä¸€æ¬¡</button>
      <button id="btnPracticeWrong" class="ghost">åªç·´æœ¬æ¬¡éŒ¯é¡Œ</button>
    </div>

    <h3 style="margin-top:12px">éŒ¯é¡Œ</h3>
    <div id="wrongList" class="list"></div>
  </section>

  <section class="card">
    <div class="row" style="align-items:flex-start">
      <div style="flex:2">
        <h3 style="margin:0 0 6px">æœ€è¿‘ 10 æ¬¡æˆç¸¾</h3>
        <div id="history" class="list"></div>
      </div>
      <div style="flex:1">
        <h3 style="margin:0 0 6px">å¿«æ·éµ</h3>
        <ul class="small muted">
          <li>ä½œç­”ä¸­ï¼š<span class="kbd">Enter</span> ä¸‹ä¸€é¡Œï¼é€å‡º</li>
          <li>é¸æ“‡é¡Œï¼š<span class="kbd">1-4</span> é¸æ“‡é¸é …</li>
          <li>å¡«ç©ºé¡Œï¼š<span class="kbd">Enter</span> é€å‡ºç­”æ¡ˆ</li>
        </ul>
      </div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">ä½¿ç”¨èªªæ˜</h3>
    <ol class="small">
      <li>åœ¨ Google è©¦ç®—è¡¨ï¼šæª”æ¡ˆ â†’ å…±ç”¨ â†’ <b>ç™¼å¸ƒåˆ°ç¶²è·¯</b> â†’ CSVï¼ˆå››æ¬„ï¼šåºè™Ÿã€è‹±æ–‡ã€è©æ€§ã€ä¸­æ–‡ï¼‰ã€‚</li>
      <li>è²¼åˆ°ã€Œé¡Œåº«ä¾†æºã€æ¬„æˆ–ç›´æ¥ç”¨é è¨­é¡Œåº«ã€‚ç³»çµ±åªè¦æ±‚ã€Œè‹±æ–‡ã€å¿…å¡«ï¼›å¡«ç©ºé¡Œæœƒè‡ªå‹•é¿é–‹æ²’æœ‰ä¸­æ–‡çš„æ¢ç›®ã€‚</li>
      <li>è¨­å®šå‡ºé¡Œç¯„åœèˆ‡é¡Œæ•¸ï¼Œé¸æ“‡æ¨¡å¼å¾Œé–‹å§‹ã€‚</li>
      <li>ä½œç­”å®Œç•¢æ‰æœƒé¡¯ç¤ºåˆ†æ•¸èˆ‡éŒ¯é¡Œã€‚æœ¬æ©Ÿç€è¦½å™¨æœƒä¿å­˜æœ€è¿‘åæ¬¡ç´€éŒ„ã€‚</li>
    </ol>
    <p class="small muted">éš±ç§ï¼šæ‰€æœ‰è³‡æ–™åƒ…åœ¨æœ¬æ©Ÿç€è¦½å™¨é‹ä½œèˆ‡å„²å­˜ï¼ˆlocalStorageï¼‰ã€‚</p>
  </section>
</main>

<script>
// é è¨­é¡Œåº«ï¼šä½ çš„ Google è©¦ç®—è¡¨ã€Œç™¼å¸ƒç‚º CSVã€é€£çµï¼ˆgid=0ï¼‰ã€‚
const DEFAULT_DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKoU6W5HiPC0_VB2fP0rf8g8EZGaATG19PGCTfeTSGA6bhI7zTjuDYnupIDn616spq0p43T6Z0cVdd/pub?gid=0&single=true&output=csv";

// ====== å°å·¥å…· ======
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
const HISTORY_KEY = 'vocab-quiz-history-v1';
const DATA_CACHE_KEY = 'vocab-quiz-data-url-v1';

const state = {
  raw: [], // {en,pos,zh}
  pool: [], quiz: [], i:0, right:0,
  wrongItems: [], currentQ:null, lastWrongPool: [],
};

function escapeHtml(s){return String(s).replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

function saveHistory(rec){ const list = loadHistory(); list.unshift(rec); while(list.length>10) list.pop(); localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); renderHistory(); }
function loadHistory(){ try{return JSON.parse(localStorage.getItem(HISTORY_KEY))||[]}catch{ return [] } }
function renderHistory(){ const box=$('#history'); const list=loadHistory(); box.innerHTML = list.length? '' : '<div class="muted small">å°šç„¡ç´€éŒ„</div>'; list.forEach(r=>{ const div=document.createElement('div'); div.className='wrong-item'; div.innerHTML = `<div class="row"><b>${r.score}%</b> <span class="muted small">ï½œ${r.mode}ï½œç¯„åœï¼š${escapeHtml(r.range)}</span><span class="right small">${new Date(r.time).toLocaleString()}</span></div>`; box.appendChild(div); }); }
$('#btnClearHistory').onclick = ()=>{ localStorage.removeItem(HISTORY_KEY); renderHistory(); };

// ====== é¡Œåº«è¼‰å…¥ ======
const datasetStatus = $('#datasetStatus');
const sheetUrlInput = $('#sheetUrl');
const diagBox = $('#diagBox');

$('#btnUseSample').onclick = ()=>{ loadSample(); };
$('#btnLoadDefault').onclick = async ()=>{ if(!DEFAULT_DATA_URL){ alert('å°šæœªè¨­å®š DEFAULT_DATA_URL'); return; } sheetUrlInput.value = DEFAULT_DATA_URL; localStorage.removeItem(DATA_CACHE_KEY); $('#btnLoad').click(); };
$('#btnLoad').onclick = async ()=>{ const url = sheetUrlInput.value.trim(); if(!url){ alert('è«‹å…ˆè²¼ä¸Š CSV é€£çµ'); return } await loadCsv(url, {cache:true}); };

async function loadCsv(url, {cache=false}={}){
  datasetStatus.innerHTML = 'é¡Œåº«ï¼š<span class="muted">è®€å–ä¸­â€¦</span>';
  diag('');
  try{
    const data = await fetchCsv(url);
    state.raw = data;
    if(cache) localStorage.setItem(DATA_CACHE_KEY, url);
    datasetStatus.innerHTML = `é¡Œåº«ï¼š<b>${state.raw.length}</b> ç­†`;
    showDiagPreview(state.raw);
  }catch(e){
    console.error(e);
    datasetStatus.innerHTML = 'é¡Œåº«ï¼š<span class="muted">è®€å–å¤±æ•—</span>';
    diag(`<span class="chip">è¨ºæ–·</span> ${escapeHtml(e.message)}\nâ€£ è«‹ç¢ºèªé€£çµç‚ºã€Œç™¼å¸ƒåˆ°ç¶²è·¯ â†’ CSVã€ä¸”å¯å…¬é–‹è®€å–ã€‚`);
    alert('è®€å–å¤±æ•—ï¼š'+ e.message);
  }
}

// è§£æï¼šå›ºå®šåƒå››æ¬„è¡¨é ­ï¼ˆåºè™Ÿ/è‹±æ–‡/è©æ€§/ä¸­æ–‡ï¼‰ã€‚åªè¦æ±‚è‹±æ–‡å¿…å¡«ã€‚
async function fetchCsv(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('CSV è¼‰å…¥å¤±æ•—ï¼ˆHTTP '+res.status+'ï¼‰');
  const text = await res.text();

  // CSV splitï¼ˆè™•ç†å¼•è™ŸåŒ…ä½é€—è™Ÿï¼‰
  const rows = text.split(/\r?\n/)
    .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s => s.replace(/^"|"$/g,'').trim()))
    .filter(r => r.length && r.some(x => x !== ''));

  if(rows.length < 2) throw new Error('CSV æ²’æœ‰è³‡æ–™åˆ—ï¼ˆå¯èƒ½åªç™¼ä½ˆäº†è¡¨é ­æˆ–é€£çµéŒ¯èª¤ï¼‰');

  // è¡¨é ­å®šä½
  const header = rows[0].map(h => h.replace(/\s+/g,'').toLowerCase());
  const find = kw => header.findIndex(h => h.includes(kw));
  const iEn  = find('è‹±æ–‡');
  const iPos = find('è©æ€§');
  const iZh  = find('ä¸­æ–‡');
  if(iEn < 0) throw new Error('æ‰¾ä¸åˆ°ã€Œè‹±æ–‡ã€æ¬„ä½ï¼ˆè«‹ç¢ºèªè¡¨é ­ï¼šåºè™Ÿ/è‹±æ–‡/è©æ€§/ä¸­æ–‡ï¼‰');

  const dataRows = rows.slice(1);
  const data = dataRows.map(r => ({ en: r[iEn] || '', pos: (iPos>=0? r[iPos] : '') || '', zh: (iZh>=0? r[iZh] : '') || '' }))
                       .filter(x => x.en);
  if(!data.length) throw new Error('æˆåŠŸè®€åˆ° CSVï¼Œä½†æ‰€æœ‰è³‡æ–™çš„ã€Œè‹±æ–‡ã€æ¬„ç‚ºç©ºï¼Œæˆ–è¢«è§£æå™¨éæ¿¾ã€‚');
  return data;
}

function diag(html){ if(!html){ diagBox.classList.add('hide'); diagBox.innerHTML=''; } else { diagBox.classList.remove('hide'); diagBox.innerHTML = html.replace(/\n/g,'<br>'); } }
function showDiagPreview(list){
  const head = `<span class="chip">è¼‰å…¥æˆåŠŸ</span> å…± ${list.length} ç­†`;
  const prev = list.slice(0,3).map((x,i)=>`#${i+1} en=<b>${escapeHtml(x.en)}</b> Â· pos=${escapeHtml(x.pos||'')} Â· zh=${escapeHtml(x.zh||'(ç„¡)')}`).join('<br>');
  diag(head + '<br>' + prev);
}

function loadSample(){
  state.raw = [
    {en:'apple', pos:'n.', zh:'è˜‹æœ'},
    {en:'banana', pos:'n.', zh:'é¦™è•‰'},
    {en:'like', pos:'v.', zh:'å–œæ­¡'},
    {en:'school', pos:'n.', zh:'å­¸æ ¡'},
    {en:'fast', pos:'adj.', zh:'å¿«é€Ÿçš„'},
    {en:'run', pos:'v.', zh:'è·‘æ­¥'},
  ];
  datasetStatus.innerHTML = `é¡Œåº«ï¼š<b>${state.raw.length}</b> ç­†ï¼ˆç¯„ä¾‹ï¼‰`;
  showDiagPreview(state.raw);
}

// å•Ÿå‹•ï¼šå…ˆè®€å¿«å– URLï¼›å¦å‰‡ç”¨é è¨­é¡Œåº«
(async function initLoad(){
  renderHistory();
  const cached = localStorage.getItem(DATA_CACHE_KEY);
  try{
    if(cached){ sheetUrlInput.value = cached; await loadCsv(cached); datasetStatus.innerHTML += 'ï¼ˆä¸Šæ¬¡ä½¿ç”¨ï¼‰'; }
    else if(DEFAULT_DATA_URL){ sheetUrlInput.value = DEFAULT_DATA_URL; await loadCsv(DEFAULT_DATA_URL, {cache:true}); datasetStatus.innerHTML += 'ï¼ˆé è¨­ï¼‰'; }
  }catch(e){ console.error(e); datasetStatus.innerHTML = 'é¡Œåº«ï¼š<span class="muted">è‡ªå‹•è¼‰å…¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•è²¼ä¸Šæˆ–ç”¨ç¯„ä¾‹</span>'; }
})();

// ====== å‡ºé¡Œ ======
$('#btnStart').onclick = startQuiz;
$('#btnWrongPractice').onclick = ()=>{ if(!state.lastWrongPool.length){ alert('å°šç„¡å¯ç”¨éŒ¯é¡Œã€‚'); return } startQuiz({ useWrongPool:true }); };

function parseRange(str, max){
  if(!str) return Array.from({length:max},(_,i)=>i);
  const parts = str.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(Boolean);
  const idx = new Set();
  for(const p of parts){
    const m = p.match(/^(\d+)\s*[-~åˆ°]\s*(\d+)$/);
    if(m){ let a=+m[1]-1, b=+m[2]-1; if(a>b) [a,b]=[b,a]; for(let i=a;i<=b && i<max;i++) idx.add(i); }
    else if(/^\d+$/.test(p)){ const i=+p-1; if(i>=0 && i<max) idx.add(i); }
  }
  return [...idx].sort((a,b)=>a-b);
}

function pickUnique(arr,n){ const pool=arr.slice(); const out=[]; while(out.length<n && pool.length){ const i=Math.floor(Math.random()*(pool.length)); out.push(pool.splice(i,1)[0]); } return out; }

function startQuiz(opts={}){
  if(!state.raw.length){ alert('è«‹å…ˆè¼‰å…¥é¡Œåº«'); return }
  const rangeStr = $('#range').value.trim();
  const poolIdx = opts.useWrongPool ? state.lastWrongPool.slice() : parseRange(rangeStr, state.raw.length);
  const count = Math.max(1, Math.min(+$('#count').value||10, poolIdx.length));
  const modeSel = $('#mode').value; // choice / fill / mixed
  const displaySel = $('#display').value; // zh-pos / en-pos / auto

  state.pool = pickUnique(poolIdx, count);
  state.quiz = state.pool.map(i=>({ ...state.raw[i], idx:i }));
  state.i=0; state.right=0; state.wrongItems=[]; state.currentQ=null;

  $('#qTotal').textContent = state.quiz.length;
  $('#resultCard').classList.add('hide');
  $('#quizCard').classList.remove('hide');
  $('#btnSpeak').disabled = true;

  const isTTS = $('#allowTTS').checked;
  if(isTTS && !('speechSynthesis' in window)) alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆï¼ˆTTSï¼‰ã€‚');

  nextQuestion({ modeSel, displaySel });
}

function buildQuestion(q, prefMode, displaySel){
  let mode = prefMode;
  if(mode==='mixed') mode = Math.random()<0.5 ? 'choice' : 'fill';
  // æ²’æœ‰ä¸­æ–‡ï¼Œå°±ä¸è¦å‡ºå¡«ç©ºé¡Œ
  if(mode==='fill' && !q.zh) mode = 'choice';

  // é¡Œç›®å‘ˆç¾
  let stem = '', pos = q.pos||''; let display = displaySel;
  if(display==='auto') display = (mode==='choice') ? 'zh-pos' : 'zh-pos';
  if(display==='en-pos'){ stem = q.en; }
  if(display==='zh-pos'){ stem = q.zh || q.en; }

  // é¸é …
  let options = null, answer = q.en;
  if(mode==='choice'){
    const samePos = state.raw.filter(x=>x.en!==q.en && (x.pos||'')===(q.pos||''));
    const base = samePos.length? samePos : state.raw.filter(x=>x.en!==q.en);
    const distractors = pickUnique(base, 3).map(x=>x.en);
    options = shuffle([q.en, ...distractors]);
  }

  return { mode, stem, pos, display, options, answer };
}

function nextQuestion(ctx){
  if(state.i >= state.quiz.length) return finishQuiz();
  const q = state.quiz[state.i];
  const prefMode = $('#mode').value; const displaySel = ctx?.displaySel || $('#display').value;
  const meta = buildQuestion(q, prefMode, displaySel); state.currentQ = { ...q, ...meta };

  $('#qIndex').textContent = state.i+1;
  $('#progBar').style.width = ((state.i/state.quiz.length)*100).toFixed(1)+'%';
  $('#qStem').textContent = meta.stem;
  $('#qPos').textContent = meta.pos?`è©æ€§ï¼š${meta.pos}`:'';
  $('#hintText').textContent = '';

  $('#btnSpeak').disabled = !( $('#allowTTS').checked && meta.answer );

  if(meta.mode==='choice'){
    $('#fillBox').classList.add('hide');
    $('#choiceBox').classList.remove('hide');
    renderChoices(meta);
  }else{
    $('#choiceBox').classList.add('hide');
    $('#fillBox').classList.remove('hide');
    $('#fillInput').value='';
    $('#fillInput').focus();
  }
}

function renderChoices(meta){
  const box = $('#choiceBox'); box.innerHTML='';
  meta.options.forEach((opt,idx)=>{
    const btn = document.createElement('button');
    btn.className='choice';
    btn.innerHTML = `<span class="kbd" style="margin-right:8px">${idx+1}</span> ${escapeHtml(opt)}`;
    btn.onclick = ()=>choose(opt);
    box.appendChild(btn);
  });
}

function sameWord(a,b){ return $('#caseIns').checked ? a.trim().toLowerCase()===b.trim().toLowerCase() : a.trim()===b.trim(); }
function choose(opt){ const {answer}=state.currentQ; const correct = sameWord(opt, answer); markChoice(opt, correct); recordAnswer(correct, opt); }
function markChoice(opt, correct){ $$('#choiceBox .choice').forEach(btn=>{ const text = btn.textContent.replace(/^\d\s*/, '').trim(); if(sameWord(text, state.currentQ.answer)) btn.classList.add('correct'); if(sameWord(text, opt) && !correct) btn.classList.add('wrong'); btn.disabled = true; }); }

$('#btnSubmitFill').onclick = submitFill;
$('#fillInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submitFill(); }});
$('#btnNext').onclick = ()=>{ if(state.i < state.quiz.length){ state.i++; nextQuestion(); }};

function submitFill(){ const val=$('#fillInput').value; if(!val.trim()){ alert('è«‹è¼¸å…¥è‹±æ–‡ç­”æ¡ˆ'); return } const correct = sameWord(val, state.currentQ.answer); $('#fillInput').style.borderColor = correct? 'var(--ok)':'var(--bad)'; recordAnswer(correct, val); }

function recordAnswer(correct, userAns){ if(correct) state.right++; else state.wrongItems.push({ q: state.currentQ, your: userAns, ans: state.currentQ.answer }); setTimeout(()=>{ state.i++; nextQuestion(); }, 250); }

$('#btnHint').onclick = ()=>{ const first = (state.currentQ.answer||'')[0]||''; $('#hintText').textContent = first ? `æç¤ºï¼š${first}â€¦` : ''; };
$('#btnSpeak').onclick = ()=>{ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(state.currentQ.answer); u.lang='en-US'; window.speechSynthesis.speak(u); };

// éµç›¤å¿«æ·éµ
window.addEventListener('keydown', e=>{ const inQuiz = !$('#quizCard').classList.contains('hide'); if(!inQuiz) return; if(state.currentQ?.mode==='choice'){ if(['1','2','3','4'].includes(e.key)){ const i=+e.key-1; const btn=$$('#choiceBox .choice')[i]; if(btn) btn.click(); }} if(e.key==='Enter'){ if(state.currentQ?.mode==='fill'){ submitFill(); } else if(state.i < state.quiz.length){ state.i++; nextQuestion(); } }});

function finishQuiz(){
  $('#quizCard').classList.add('hide'); $('#resultCard').classList.remove('hide');
  const total=state.quiz.length; const pct=Math.round((state.right/total)*100);
  $('#scorePct').textContent = pct+'%'; $('#scoreRight').textContent = state.right; $('#scoreTotal').textContent = total;

  const box=$('#wrongList'); box.innerHTML = state.wrongItems.length? '' : '<div class="muted small">å¤ªæ£’äº†ï¼æ²’æœ‰éŒ¯é¡Œã€‚</div>';
  state.wrongItems.forEach(item=>{ const div=document.createElement('div'); div.className='wrong-item'; div.innerHTML = `<div><b>${escapeHtml(item.q.zh||'ï¼ˆç„¡ä¸­æ–‡ï¼‰')}</b> <span class="pos">${escapeHtml(item.q.pos||'')}</span></div><div class="small">æ­£è§£ï¼š<b>${escapeHtml(item.ans)}</b></div><div class="small">ä½ çš„ç­”æ¡ˆï¼š<span style="color:var(--bad)">${escapeHtml(item.your)}</span></div>`; box.appendChild(div); });

  state.lastWrongPool = state.wrongItems.map(w=>w.q.idx);
  $('#btnWrongPractice').disabled = state.lastWrongPool.length===0;

  const rec = { time:Date.now(), score:pct, mode:({choice:'é¸æ“‡', fill:'å¡«ç©º', mixed:'æ··åˆ'})[$('#mode').value]||$('#mode').value, range:$('#range').value||'å…¨éƒ¨', count:total };
  saveHistory(rec);
}

$('#btnRetry').onclick = ()=> startQuiz();
$('#btnPracticeWrong').onclick = ()=>{ if(!state.lastWrongPool.length){ alert('æ²’æœ‰éŒ¯é¡Œå¯ç·´'); return } startQuiz({ useWrongPool:true }); };
</script>
</body>
</html>
