<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±å–®ç·´ç¿’ï½œé¸æ“‡é¡Œï¼å¡«ç©ºé¡Œ</title>
  <style>
    :root{
      --bg:#0b1020; --card:#12182b; --muted:#9aa4bf; --text:#e6ecff; --accent:#5dd6ff; --ok:#3ddc97; --warn:#ffd166; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1f 0%,#0c1328 100%);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, PingFang TC, Helvetica, Arial}
    header{padding:18px 16px;border-bottom:1px solid #1b2440;position:sticky;top:0;background:rgba(9,14,28,.85);backdrop-filter: blur(10px);z-index:10}
    main{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    .grid{display:grid;gap:12px}
    .controls{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid #1b2440;border-radius:14px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243154;background:#0b1224;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(93,214,255,.15)}
    button{cursor:pointer;background:#1a2446;border-color:#223063}
    button.primary{background:linear-gradient(180deg,#2a76ff,#1d5aff);border:none}
    button.ghost{background:transparent;border:1px dashed #314070}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0d1630;border:1px solid #223063;color:#c7d3ff;font-size:12px}
    .question{font-size:22px;margin:12px 0 8px}
    .pos{font-size:13px;color:var(--muted)}
    .choices{display:grid;gap:10px}
    .choices button{justify-content:flex-start}
    .choice{padding:12px;border-radius:12px;background:#0b1224;border:1px solid #223063;text-align:left}
    .choice.correct{border-color:var(--ok)}
    .choice.wrong{border-color:var(--bad)}
    .progress{height:8px;background:#11193a;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:linear-gradient(90deg,#2a76ff,#5dd6ff)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;padding:2px 6px;border:1px solid #2b3b6d;border-radius:6px;background:#0d1430}
    .list{display:grid;gap:8px}
    .wrong-item{padding:10px;border-radius:10px;border:1px solid #2a375f;background:#0d1430}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .small{font-size:12px}
    .center{text-align:center}
    .hide{display:none}
    .hint{font-size:12px;color:#a9b6e6;margin-top:6px}
    .footer{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
    .link{color:#7ec8ff}
  </style>
</head>
<body>
<header class="row">
  <h1>è‹±å–®ç·´ç¿’ï¼ˆé¸æ“‡ï¼å¡«ç©ºï¼‰</h1>
  <div class="right pill" id="datasetStatus">é¡Œåº«ï¼š<span class="muted">å°šæœªè¼‰å…¥</span></div>
</header>
<main class="grid">
  <section class="card">
    <div class="grid controls">
      <div>
        <label>é¡Œåº«ä¾†æºï¼ˆGoogle è©¦ç®—è¡¨ï¼‰</label>
        <input id="sheetUrl" placeholder="è²¼ä¸Šå·²å…¬é–‹çš„ CSV é€£çµï¼ˆæª”æ¡ˆâ†’å…±ç”¨â†’ç™¼å¸ƒåˆ°ç¶²è·¯ï¼Œé¸ CSVï¼‰" />
        <div class="row" style="margin-top:8px">
          <button id="btnLoad" class="primary">è¼‰å…¥é¡Œåº«</button>
          <button id="btnUseSample" class="ghost">ä½¿ç”¨ç¯„ä¾‹é¡Œåº«</button>
        </div>
        <div class="hint">æ ¼å¼ï¼šä¸‰æ¬„ <b>ä¸­æ–‡</b>ã€<b>è‹±æ–‡</b>ã€<b>è©æ€§</b>ã€‚<br>ä¹Ÿå¯ç”¨ Google Visualization JSONï¼ˆ?gviz=1ï¼‰çš„ URLï¼Œç³»çµ±æœƒè‡ªå‹•è§£æã€‚</div>
      </div>
      <div>
        <label>å‡ºé¡Œç¯„åœï¼ˆç´¢å¼•ï¼‰</label>
        <input id="range" placeholder="ä¾‹å¦‚ï¼š1-100 æˆ– 1-50, 120, 150-180"/>
        <div class="hint">ä»¥é¡Œåº«åˆ—è™Ÿç‚ºåŸºæº–ï¼ˆ1 è¡¨ç¬¬ä¸€åˆ—è³‡æ–™ï¼‰ã€‚æœƒè‡ªå‹•å¿½ç•¥è¶…å‡ºç¯„åœçš„ç´¢å¼•ã€‚</div>
      </div>
      <div>
        <label>é¡Œç›®æ•¸é‡</label>
        <input id="count" type="number" min="1" value="10" />
      </div>
      <div>
        <label>æ¸¬é©—æ¨¡å¼</label>
        <select id="mode">
          <option value="choice">é¸æ“‡é¡Œï¼ˆå››é¸ä¸€ï¼‰</option>
          <option value="fill">å¡«ç©ºé¡Œï¼ˆä¸­æ–‡ï¼‹è©æ€§ â†’ è‹±æ–‡ï¼‰</option>
          <option value="mixed">æ··åˆï¼ˆéš¨æ©ŸæŠ½é¸æ“‡æˆ–å¡«ç©ºï¼‰</option>
        </select>
      </div>
      <div>
        <label>é¡Œç›®é¡¯ç¤º</label>
        <select id="display">
          <option value="en-pos">é¡¯ç¤ºï¼šè‹±æ–‡ï¼‹è©æ€§ï¼ˆé©åˆä¸­æ–‡ä½œç­”ï¼‰</option>
          <option value="zh-pos">é¡¯ç¤ºï¼šä¸­æ–‡ï¼‹è©æ€§ï¼ˆé©åˆè‹±æ–‡ä½œç­”ï¼‰</option>
          <option value="auto">è‡ªå‹•ï¼ˆä¾æ¨¡å¼èª¿æ•´ï¼‰</option>
        </select>
        <div class="hint">é¸æ“‡é¡Œå»ºè­°é¡¯ç¤º <b>ä¸­æ–‡ï¼‹è©æ€§</b>ï¼›å¡«ç©ºé¡Œä¸€å¾‹ <b>ä¸­æ–‡ï¼‹è©æ€§</b>ã€‚</div>
      </div>
      <div>
        <label>å…¶ä»–</label>
        <div class="row">
          <label class="pill" style="gap:8px"><input type="checkbox" id="allowTTS"> å•Ÿç”¨è‹±èªç™¼éŸ³ï¼ˆTTSï¼‰</label>
          <label class="pill" style="gap:8px"><input type="checkbox" id="caseIns"> è‹±æ–‡ä¸åˆ†å¤§å°å¯«</label>
        </div>
      </div>
    </div>
    <div class="footer">
      <button id="btnStart" class="primary">é–‹å§‹æ¸¬é©—</button>
      <button id="btnWrongPractice" class="ghost" title="ä½¿ç”¨æœ€è¿‘ä¸€æ¬¡éŒ¯é¡Œå†ç·´ç¿’" disabled>åªç·´éŒ¯é¡Œ</button>
      <button id="btnClearHistory" class="ghost">æ¸…é™¤æˆç¸¾ç´€éŒ„</button>
    </div>
  </section>

  <section id="quizCard" class="card hide">
    <div class="row">
      <div class="pill" id="quizMeta">ç¬¬ <span id="qIndex">1</span> / <span id="qTotal">10</span> é¡Œ</div>
      <div class="right" style="min-width:200px">
        <div class="progress"><div id="progBar" style="width:0%"></div></div>
      </div>
    </div>
    <div id="qStem" class="question">é¡Œç›®è¼‰å…¥ä¸­â€¦</div>
    <div id="qPos" class="pos"></div>

    <div id="choiceBox" class="choices"></div>

    <div id="fillBox" class="grid" style="gap:8px">
      <input id="fillInput" placeholder="è¼¸å…¥è‹±æ–‡ç­”æ¡ˆï¼ˆæŒ‰ Enter é€å‡ºï¼‰" autocomplete="off"/>
      <div class="row">
        <button id="btnSubmitFill" class="primary">é€å‡ºç­”æ¡ˆ</button>
        <button id="btnHint" class="ghost">æç¤ºï¼ˆé¦–å­—æ¯ï¼‰</button>
        <span id="hintText" class="hint"></span>
      </div>
    </div>

    <div class="footer">
      <button id="btnNext" class="ghost">ä¸‹ä¸€é¡Œ <span class="kbd">Enter</span></button>
      <button id="btnSpeak" class="ghost" title="ç™¼éŸ³" disabled>ğŸ”ˆ ç™¼éŸ³</button>
    </div>
  </section>

  <section id="resultCard" class="card hide">
    <h2>æˆç¸¾</h2>
    <p class="muted">æœ¬æ¬¡åˆ†æ•¸ï¼š<b id="scorePct">0%</b>ï¼ˆç­”å° <span id="scoreRight">0</span> / <span id="scoreTotal">0</span>ï¼‰</p>
    <div class="footer">
      <button id="btnRetry" class="primary">å†æ¸¬ä¸€æ¬¡</button>
      <button id="btnPracticeWrong" class="ghost">åªç·´æœ¬æ¬¡éŒ¯é¡Œ</button>
    </div>

    <h3 style="margin-top:12px">éŒ¯é¡Œ</h3>
    <div id="wrongList" class="list"></div>
  </section>

  <section class="card">
    <div class="row" style="align-items:flex-start">
      <div style="flex:2">
        <h3 style="margin:0 0 6px">æœ€è¿‘ 10 æ¬¡æˆç¸¾</h3>
        <div id="history" class="list"></div>
      </div>
      <div style="flex:1">
        <h3 style="margin:0 0 6px">å¿«æ·éµ</h3>
        <ul class="small muted">
          <li>ä½œç­”ä¸­ï¼š<span class="kbd">Enter</span> ä¸‹ä¸€é¡Œï¼é€å‡º</li>
          <li>é¸æ“‡é¡Œï¼š<span class="kbd">1-4</span> é¸æ“‡é¸é …</li>
          <li>å¡«ç©ºé¡Œï¼š<span class="kbd">Enter</span> é€å‡ºç­”æ¡ˆ</li>
        </ul>
      </div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">ä½¿ç”¨èªªæ˜</h3>
    <ol class="small">
      <li>åœ¨ Google è©¦ç®—è¡¨ï¼šæª”æ¡ˆ â†’ å…±ç”¨ â†’ <b>ç™¼å¸ƒåˆ°ç¶²è·¯</b>ï¼Œé¸æ“‡ CSVï¼›æˆ–åœ¨åˆ†äº«é€£çµå¾ŒæŠŠç¶²å€åŠ ä¸Š <code>?gviz=1</code> ä½¿ç”¨ JSONã€‚</li>
      <li>è²¼åˆ°ã€Œé¡Œåº«ä¾†æºã€æ¬„ä¸¦æŒ‰ã€Œè¼‰å…¥é¡Œåº«ã€ã€‚ç³»çµ±æœƒè®€å–ä¸‰æ¬„ï¼šä¸­æ–‡ã€è‹±æ–‡ã€è©æ€§ã€‚</li>
      <li>è¨­å®šå‡ºé¡Œç¯„åœèˆ‡é¡Œæ•¸ï¼Œé¸æ“‡æ¨¡å¼å¾Œé–‹å§‹ã€‚</li>
      <li>ä½œç­”å®Œç•¢æ‰æœƒé¡¯ç¤ºåˆ†æ•¸èˆ‡éŒ¯é¡Œã€‚æœ¬æ©Ÿç€è¦½å™¨æœƒä¿å­˜æœ€è¿‘åæ¬¡ç´€éŒ„ã€‚</li>
    </ol>
    <p class="small muted">éš±ç§ï¼šæ‰€æœ‰è³‡æ–™åƒ…åœ¨æœ¬æ©Ÿç€è¦½å™¨é‹ä½œèˆ‡å„²å­˜ï¼ˆlocalStorageï¼‰ã€‚</p>
  </section>
</main>

<script>
// ====== è³‡æ–™èˆ‡å·¥å…· ======
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
const state = {
  raw: [], // {zh,en,pos}
  pool: [], // å‡ºé¡Œæ± ï¼ˆç´¢å¼•ï¼‰
  quiz: [], // é¡Œç›® objects
  i: 0,
  right: 0,
  wrongItems: [], // {q, your, ans}
  currentQ: null,
  lastWrongPool: [], // å„²å­˜å‰æ¬¡éŒ¯é¡Œçš„ç´¢å¼•
};

const HISTORY_KEY = 'vocab-quiz-history-v1';
const DATA_CACHE_KEY = 'vocab-quiz-data-url-v1';

function saveHistory(rec){
  const list = loadHistory();
  list.unshift(rec);
  while(list.length>10) list.pop();
  localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
  renderHistory();
}
function loadHistory(){
  try{return JSON.parse(localStorage.getItem(HISTORY_KEY))||[]}catch{ return [] }
}
function renderHistory(){
  const box = $('#history');
  const list = loadHistory();
  box.innerHTML = list.length ? '' : '<div class="muted small">å°šç„¡ç´€éŒ„</div>';
  list.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'wrong-item';
    div.innerHTML = `<div class="row"><b>${r.score}%</b> <span class="muted small">ï½œ${r.mode}ï½œç¯„åœï¼š${escapeHtml(r.range)}</span><span class="right small">${new Date(r.time).toLocaleString()}</span></div>`;
    box.appendChild(div);
  });
}
$('#btnClearHistory').onclick = ()=>{ localStorage.removeItem(HISTORY_KEY); renderHistory(); };

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

// ====== é¡Œåº«è¼‰å…¥ ======
const datasetStatus = $('#datasetStatus');
const sheetUrlInput = $('#sheetUrl');

$('#btnUseSample').onclick = ()=>{
  loadSample();
};
$('#btnLoad').onclick = async ()=>{
  const url = sheetUrlInput.value.trim();
  if(!url){ alert('è«‹å…ˆè²¼ä¸Š Google è©¦ç®—è¡¨å…¬é–‹é€£çµï¼ˆCSV æˆ– ?gviz=1 JSONï¼‰'); return }
  datasetStatus.innerHTML = 'é¡Œåº«ï¼š<span class="muted">è®€å–ä¸­â€¦</span>';
  try{
    let data;
    if(url.includes('gviz=1')){
      data = await fetchGvizJson(url);
    }else{
      data = await fetchCsv(url);
    }
    state.raw = data;
    localStorage.setItem(DATA_CACHE_KEY, url);
    datasetStatus.innerHTML = `é¡Œåº«ï¼š<b>${state.raw.length}</b> ç­†`;
  }catch(e){
    console.error(e);
    datasetStatus.innerHTML = 'é¡Œåº«ï¼š<span class="muted">è®€å–å¤±æ•—</span>';
    alert('è®€å–å¤±æ•—ï¼š'+ e.message);
  }
};

async function fetchCsv(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('CSV è¼‰å…¥å¤±æ•—');
  const text = await res.text();
  const rows = text.split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^\"|\"$/g,'').trim())).filter(r=>r.filter(Boolean).length>=2);
  // æœŸå¾…ï¼šä¸­æ–‡, è‹±æ–‡, è©æ€§
  return rows.map(r=>({ zh:r[0]||'', en:r[1]||'', pos:r[2]||'' })).filter(x=>x.zh && x.en);
}
async function fetchGvizJson(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('JSON è¼‰å…¥å¤±æ•—');
  const text = await res.text();
  const json = JSON.parse(text.replace(/^.*google\.visualization\.Query\.setResponse\(/,'').replace(/\);?\s*$/,''));
  const table = json.table; // columns: assume zh,en,pos
  const rows = table.rows.map(r=>r.c.map(c=>c?String(c.v):''));
  return rows.map(r=>({ zh:r[0]||'', en:r[1]||'', pos:r[2]||'' })).filter(x=>x.zh && x.en);
}

function loadSample(){
  state.raw = [
    {zh:'è˜‹æœ', en:'apple', pos:'n.'},
    {zh:'é¦™è•‰', en:'banana', pos:'n.'},
    {zh:'å–œæ­¡', en:'like', pos:'v.'},
    {zh:'å­¸æ ¡', en:'school', pos:'n.'},
    {zh:'å¿«é€Ÿçš„', en:'fast', pos:'adj.'},
    {zh:'è·‘æ­¥', en:'run', pos:'v.'},
    {zh:'è€å¸«', en:'teacher', pos:'n.'},
    {zh:'å­¸ç”Ÿ', en:'student', pos:'n.'},
    {zh:'æ›¸æœ¬', en:'book', pos:'n.'},
    {zh:'é‰›ç­†', en:'pencil', pos:'n.'},
  ];
  datasetStatus.innerHTML = `é¡Œåº«ï¼š<b>${state.raw.length}</b> ç­†ï¼ˆç¯„ä¾‹ï¼‰`;
}

// å•Ÿå‹•æ™‚ï¼Œè‹¥æœ‰å¿«å– URLï¼Œå˜—è©¦è®€å–
(async function initLoad(){
  renderHistory();
  const cached = localStorage.getItem(DATA_CACHE_KEY);
  if(cached){ sheetUrlInput.value = cached; try{ if(cached.includes('gviz=1')) state.raw = await fetchGvizJson(cached); else state.raw = await fetchCsv(cached); datasetStatus.innerHTML = `é¡Œåº«ï¼š<b>${state.raw.length}</b> ç­†`; }catch{}}
})();

// ====== å‡ºé¡Œ ======
$('#btnStart').onclick = startQuiz;
$('#btnWrongPractice').onclick = ()=>{
  if(!state.lastWrongPool.length){ alert('å°šç„¡å¯ç”¨éŒ¯é¡Œã€‚'); return }
  startQuiz({ useWrongPool:true });
};

function parseRange(str, max){
  if(!str) return Array.from({length:max},(_,i)=>i);
  const parts = str.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(Boolean);
  const idx = new Set();
  for(const p of parts){
    const m = p.match(/^(\d+)\s*[-~åˆ°]\s*(\d+)$/);
    if(m){
      let a = +m[1]-1, b = +m[2]-1; if(a>b) [a,b]=[b,a];
      for(let i=a;i<=b && i<max;i++) idx.add(i);
    }else if(/^\d+$/.test(p)){
      const i = +p - 1; if(i>=0 && i<max) idx.add(i);
    }
  }
  return [...idx].sort((a,b)=>a-b);
}

function pickUnique(arr,n){
  const pool = arr.slice();
  const out=[];
  while(out.length<n && pool.length){
    const i = Math.floor(Math.random()*pool.length);
    out.push(pool.splice(i,1)[0]);
  }
  return out;
}

function startQuiz(opts={}){
  if(!state.raw.length){ alert('è«‹å…ˆè¼‰å…¥é¡Œåº«'); return }
  const rangeStr = $('#range').value.trim();
  const poolIdx = opts.useWrongPool ? state.lastWrongPool.slice() : parseRange(rangeStr, state.raw.length);
  const count = Math.max(1, Math.min(+$('#count').value||10, poolIdx.length));
  const modeSel = $('#mode').value; // choice / fill / mixed
  const displaySel = $('#display').value; // en-pos / zh-pos / auto

  state.pool = pickUnique(poolIdx, count);
  state.quiz = state.pool.map(i=>({ ...state.raw[i], idx:i }));
  state.i = 0; state.right = 0; state.wrongItems = []; state.currentQ = null;

  $('#qTotal').textContent = state.quiz.length;
  $('#resultCard').classList.add('hide');
  $('#quizCard').classList.remove('hide');
  $('#btnSpeak').disabled = true;

  const isTTS = $('#allowTTS').checked;
  if(isTTS && !('speechSynthesis' in window)) alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆï¼ˆTTSï¼‰ã€‚');

  nextQuestion({ modeSel, displaySel });
}

function buildQuestion(q, prefMode, displaySel){
  let mode = prefMode;
  if(mode==='mixed') mode = Math.random()<0.5 ? 'choice' : 'fill';

  // é¡Œç›®å‘ˆç¾
  let stem = '', pos = q.pos||'';
  let display = displaySel;
  if(display==='auto') display = (mode==='choice') ? 'zh-pos' : 'zh-pos'; // å°å°æœ‹å‹æ›´ç›´è§€
  if(display==='en-pos'){ stem = q.en; }
  if(display==='zh-pos'){ stem = q.zh; }

  // é¸é …
  let options = null, answer = q.en;
  if(mode==='choice'){
    const others = state.raw.filter(x=>x.en!==q.en && (x.pos||'')===(q.pos||''));
    const distractors = pickUnique(others.length?others:state.raw, 3).map(x=>x.en);
    options = shuffle([q.en, ...distractors]);
  }

  return { mode, stem, pos, display, options, answer };
}

function nextQuestion(ctx){
  if(state.i >= state.quiz.length){
    return finishQuiz();
  }
  const q = state.quiz[state.i];
  const prefMode = $('#mode').value;
  const displaySel = ctx?.displaySel || $('#display').value;
  const meta = buildQuestion(q, prefMode, displaySel);
  state.currentQ = { ...q, ...meta };

  $('#qIndex').textContent = state.i+1;
  $('#progBar').style.width = ((state.i/state.quiz.length)*100).toFixed(1)+'%';
  $('#qStem').textContent = meta.stem;
  $('#qPos').textContent = meta.pos?`è©æ€§ï¼š${meta.pos}`:'';
  $('#hintText').textContent = '';

  // TTS æ§åˆ¶
  $('#btnSpeak').disabled = !( $('#allowTTS').checked && meta.answer );

  // é¡¯ç¤ºå°æ‡‰ UI
  if(meta.mode==='choice'){
    $('#fillBox').classList.add('hide');
    $('#choiceBox').classList.remove('hide');
    renderChoices(meta);
  }else{
    $('#choiceBox').classList.add('hide');
    $('#fillBox').classList.remove('hide');
    $('#fillInput').value='';
    $('#fillInput').focus();
  }
}

function renderChoices(meta){
  const box = $('#choiceBox');
  box.innerHTML='';
  meta.options.forEach((opt,idx)=>{
    const btn = document.createElement('button');
    btn.className='choice';
    btn.innerHTML = `<span class="kbd" style="margin-right:8px">${idx+1}</span> ${escapeHtml(opt)}`;
    btn.onclick = ()=>choose(opt);
    box.appendChild(btn);
  });
}

function choose(opt){
  const {answer} = state.currentQ;
  const correct = sameWord(opt, answer);
  markChoice(opt, correct);
  recordAnswer(correct, opt);
}

function markChoice(opt, correct){
  $$('#choiceBox .choice').forEach(btn=>{
    const text = btn.textContent.replace(/^\d\s*/, '').trim();
    if(sameWord(text, state.currentQ.answer)) btn.classList.add('correct');
    if(sameWord(text, opt) && !correct) btn.classList.add('wrong');
    btn.disabled = true;
  });
}

function sameWord(a,b){
  if($('#caseIns').checked) return a.trim().toLowerCase() === b.trim().toLowerCase();
  return a.trim()===b.trim();
}

$('#btnSubmitFill').onclick = submitFill;
$('#fillInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submitFill(); }});
$('#btnNext').onclick = ()=>{ if(state.i < state.quiz.length){ state.i++; nextQuestion(); }};

function submitFill(){
  const val = $('#fillInput').value;
  if(!val.trim()){ alert('è«‹è¼¸å…¥è‹±æ–‡ç­”æ¡ˆ'); return }
  const correct = sameWord(val, state.currentQ.answer);
  if(correct){ $('#fillInput').style.borderColor = 'var(--ok)'; }
  else{ $('#fillInput').style.borderColor = 'var(--bad)'; }
  recordAnswer(correct, val);
}

function recordAnswer(correct, userAns){
  if(correct) state.right++;
  else state.wrongItems.push({ q: state.currentQ, your: userAns, ans: state.currentQ.answer });
  // å»¶é² 300ms å†é€²ä¸‹ä¸€é¡Œï¼Œè®“é¡è‰²æœ‰å›é¥‹
  setTimeout(()=>{ state.i++; nextQuestion(); }, 250);
}

$('#btnHint').onclick = ()=>{
  const first = (state.currentQ.answer||'')[0]||'';
  $('#hintText').textContent = first ? `æç¤ºï¼š${first}â€¦` : '';
};

$('#btnSpeak').onclick = ()=>{
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(state.currentQ.answer);
  u.lang = 'en-US';
  window.speechSynthesis.speak(u);
};

// éµç›¤å¿«æ·éµ
window.addEventListener('keydown', e=>{
  const inQuiz = !$('#quizCard').classList.contains('hide');
  if(!inQuiz) return;
  if(state.currentQ?.mode==='choice'){
    if(['1','2','3','4'].includes(e.key)){
      const i = +e.key - 1; const btn = $$('#choiceBox .choice')[i]; if(btn) btn.click();
    }
  }
  if(e.key==='Enter'){
    if(state.currentQ?.mode==='fill'){ submitFill(); }
    else if(state.i < state.quiz.length){ state.i++; nextQuestion(); }
  }
});

function shuffle(a){
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}

function finishQuiz(){
  $('#quizCard').classList.add('hide');
  $('#resultCard').classList.remove('hide');
  const total = state.quiz.length;
  const pct = Math.round((state.right/total)*100);
  $('#scorePct').textContent = pct+'%';
  $('#scoreRight').textContent = state.right; $('#scoreTotal').textContent = total;

  // éŒ¯é¡Œåˆ—è¡¨
  const box = $('#wrongList');
  box.innerHTML = state.wrongItems.length? '' : '<div class="muted small">å¤ªæ£’äº†ï¼æ²’æœ‰éŒ¯é¡Œã€‚</div>';
  state.wrongItems.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'wrong-item';
    div.innerHTML = `<div><b>${escapeHtml(item.q.zh)}</b> <span class="pos">${escapeHtml(item.q.pos||'')}</span></div>
                     <div class="small">æ­£è§£ï¼š<b>${escapeHtml(item.ans)}</b></div>
                     <div class="small">ä½ çš„ç­”æ¡ˆï¼š<span style="color:var(--bad)">${escapeHtml(item.your)}</span></div>`;
    box.appendChild(div);
  });

  // ä¿å­˜éŒ¯é¡Œç´¢å¼•ï¼ˆçµ¦ã€Œåªç·´éŒ¯é¡Œã€ï¼‰
  state.lastWrongPool = state.wrongItems.map(w=>w.q.idx);
  $('#btnWrongPractice').disabled = state.lastWrongPool.length===0;

  // å„²å­˜æˆç¸¾
  const rec = {
    time: Date.now(),
    score: pct,
    mode: ({choice:'é¸æ“‡', fill:'å¡«ç©º', mixed:'æ··åˆ'})[$('#mode').value]||$('#mode').value,
    range: $('#range').value || 'å…¨éƒ¨',
    count: total,
  };
  saveHistory(rec);
}

$('#btnRetry').onclick = ()=> startQuiz();
$('#btnPracticeWrong').onclick = ()=>{
  if(!state.lastWrongPool.length){ alert('æ²’æœ‰éŒ¯é¡Œå¯ç·´'); return }
  startQuiz({ useWrongPool:true });
};

</script>
</body>
</html>
